# ğŸƒ ì—ì½”í•‘ í¬íŒ…ë©”ë‰´ì–¼

## ëª©ì°¨

1. [í”„ë¡œì íŠ¸ êµ¬ì„±ë„](#í”„ë¡œì íŠ¸-êµ¬ì„±ë„)
2. [ê°œë°œ í™˜ê²½](#ê°œë°œ-í™˜ê²½)
3. [í™˜ê²½ ì„¤ì •](#í™˜ê²½-ì„¤ì •)
    - [í™˜ê²½ë³€ìˆ˜](#í™˜ê²½ë³€ìˆ˜)
    - [Docker ì„¤ì¹˜](#docker-ì„¤ì¹˜)
    - [SSL ì¸ì¦ì„œ ë°œê¸‰](#ssl-ì¸ì¦ì„œ-ë°œê¸‰)
4. [EC2 í¬íŠ¸ ë²ˆí˜¸](#ec2-í¬íŠ¸-ë²ˆí˜¸)
5. [ë¹Œë“œ ë°©ë²•](#ë¹Œë“œë°©ë²•)

---

# í”„ë¡œì íŠ¸ êµ¬ì„±ë„

---

## ê°œë°œ í™˜ê²½

- Ubuntu 20.04.6 LTS (GNU/Linux 5.15.0-1063-aws x86_64)
- IntelliJ IDEA (2024.1.4)
- Visual Studio Code (1.86)

## FrontEnd

- Next.JS 14.2.13
- TypeScript 5
- Tailwind CSS 3.4.10

## BackEnd

- Java 17 (openjdk-17)
- Spring Boot 3.3.2
- Spring Security 5.7.1
- Hibernate 6.6

## DB

- MySQL 8.0.38

## INFRA

- Ubuntu 20.04.6
- Docker 27.2.1
- Jenkins 2.4777
- NginX 1.18.0

## âš™ï¸ í™˜ê²½ ì„¤ì •

### ğŸ”“ í™˜ê²½ë³€ìˆ˜

```jsx
/*.env*/
NEXT_PUBLIC_API_URL=https://j11a304.p.ssafy.io/api/api

DB_URL=jdbc:mysql://13.124.102.223:3306/sel?useUnicode=true&serverTimezone=Asia/Seoul
DB_username=ssafy
DB_password=ssafy2024

Fin_api_key= 2d0babee309f40a185f02c8b2de15634
Fin_api_url= https://finopenapi.ssafy.io/ssafy/api/v1/

file-upload-dir= ${FILE_UPLOAD_DIR:/backend/uploads}

kis-api-key=PSdlfgf8JxEoEwyXIHMJSpDrSJFUBvqa0psZ
kis-api-appsecret=yoHcFXgDDSvLlTcSjzBMlTASHnI+GsoD0Qc34RiL7RR5FJMSWIjbWpdFxhMG32giEofSrYEn2jbqr379RPhX6NpcA/K0557X4MB9Pp9iOPVQCP0b1h3mR0mR+zZMLlnqVyt0SymM02lOmrGM71w+wc2tDAFQm/dn9jre2/7cjx0vvPK/RQI=        
kis-api-url=https://openapi.koreainvestment.com:9443
websocket-url=ws://ops.koreainvestment.com:21000

```

### ğŸ‹ Docker ì„¤ì¹˜
```jsx
# Docker ì„¤ì¹˜ë¥¼ ìœ„í•œ íŒ¨í‚¤ì§€ ì—…ë°ì´íŠ¸
sudo apt update
# í•„ìˆ˜ íŒ¨í‚¤ì§€ ì„¤ì¹˜
sudo apt install -y apt-transport-https ca-certificates curl software-properties-common
# Docker GPG í‚¤ ì¶”ê°€
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
# Docker ì €ì¥ì†Œ ì¶”ê°€
sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_rele
ase -cs) stable"
# íŒ¨í‚¤ì§€ ëª©ë¡ ì—…ë°ì´íŠ¸
sudo apt update
# Docker ì„¤ì¹˜
sudo apt install -y docker-ce
# Docker ì„¤ì¹˜ í™•ì¸
docker --version
```

### ğŸ” SSL ì¸ì¦ì„œ ë°œê¸‰
```jsx
sudo apt update
sudo apt install certbot python3-certbot-nginx
sudo certbot --nginx -d ${domain}
```

## ğŸšª EC2 í¬íŠ¸ ë²ˆí˜¸

| ì„œë¹„ìŠ¤      | í¬íŠ¸ë²ˆí˜¸           | ë‹´ë‹¹ì    |
| ----------- | ------------------ | --------- |
| Back-End    | 8081               | ê°•ì„±êµ¬    |
| Front-End   | 3000               | ì•ˆí™ì°¬    |
| MySQL       | 3306               | ì •í•´ì¤€    |
| Jenkins     | 8080               | ì •í•´ì¤€    |
| Nginx       | 80(http), 443(https) | ì •í•´ì¤€    |
| Python      | 8000               | ì •í•´ì¤€    |

## âš’ï¸ **ë¹Œë“œë°©ë²•**

```jsx
pipeline {
    agent any

    environment {
        // ê³µí†µ í™˜ê²½ ë³€ìˆ˜
        GITLAB_CREDENTIALS_ID = "haejun"
        GITLAB_REPO = "https://lab.ssafy.com/s11-fintech-finance-sub1/S11P21A304.git"
        BRANCH = "develop"
        DOCKER_CREDENTIALS_ID = "docker-hub-haejun"
        SSH_CREDENTIALS_ID = "ssafy-ec2-user"
        SERVER_IP = "13.124.102.223"
        
        // ë°±ì—”ë“œìš© í™˜ê²½ ë³€ìˆ˜
        BACKEND_DOCKER_IMAGE = "seajun/backend"
        BACKEND_DOCKER_TAG = "${GIT_BRANCH.tokenize('/').last()}-${GIT_COMMIT.substring(0,7)}"
        
        // í”„ë¡ íŠ¸ì—”ë“œìš© í™˜ê²½ ë³€ìˆ˜
        FRONTEND_DOCKER_IMAGE = "seajun/nextjs-app"
        FRONTEND_DOCKER_TAG = "${GIT_BRANCH.tokenize('/').last()}-${GIT_COMMIT.substring(0,7)}"
    }

    stages {
        stage('Clone Repository') {
            steps {
                git credentialsId: "${GITLAB_CREDENTIALS_ID}", branch: "${BRANCH}", url: "${GITLAB_REPO}"
            }
        }

        // ë°±ì—”ë“œ ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ ë° ë°°í¬
        stage('Backend - Add Env') {
            steps {
                dir('backend') {
                    withCredentials([file(credentialsId: 'application', variable: 'application')]) {
                        sh '''
                            mkdir -p src/main/resources
                            chmod -R 777 src/main/resources
                            cp ${application} src/main/resources/application.yml
                        '''
                    }
                }
            }
        }

        stage('Backend - Build') {
            steps {
                dir('backend') {
                    sh 'chmod +x ./gradlew'
                    sh './gradlew clean build -Pprofile=prod'
                }
            }
        }

        stage('Backend - Docker Build') {
            steps {
                script {
                    docker.build("${BACKEND_DOCKER_IMAGE}:${BACKEND_DOCKER_TAG}", "backend")
                }
            }
        }

        stage('Backend - Push to Docker Hub') {
            steps {
                script {
                    docker.withRegistry('', "${DOCKER_CREDENTIALS_ID}") {
                        docker.image("${BACKEND_DOCKER_IMAGE}:${BACKEND_DOCKER_TAG}").push()
                        docker.image("${BACKEND_DOCKER_IMAGE}:${BACKEND_DOCKER_TAG}").push("latest")
                    }
                }
            }
        }

        // í”„ë¡ íŠ¸ì—”ë“œ ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ ë° ë°°í¬
        stage('Frontend - Docker Build') {
            steps {
                script {
                    dir('newfrontend') {
                        docker.build("${FRONTEND_DOCKER_IMAGE}:${FRONTEND_DOCKER_TAG}")
                    }
                }
            }
        }

        stage('Frontend - Push to Docker Hub') {
            steps {
                script {
                    docker.withRegistry('', "${DOCKER_CREDENTIALS_ID}") {
                        docker.image("${FRONTEND_DOCKER_IMAGE}:${FRONTEND_DOCKER_TAG}").push()
                        docker.image("${FRONTEND_DOCKER_IMAGE}:${FRONTEND_DOCKER_TAG}").push("latest")
                    }
                }
            }
        }

        stage('Prepare Nginx Config') {
            steps {
                script {
                    // GitLabì—ì„œ ê°€ì ¸ì˜¨ nginx.conf íŒŒì¼ì„ ì‘ì—… ê³µê°„ì— ë³µì‚¬
                    sh 'cp newfrontend/nginx.conf nginx.conf'
                    // í•„ìš”í•œ ê²½ìš° ì—¬ê¸°ì„œ nginx.conf íŒŒì¼ì„ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
                }
            }
        }
        stage('Copy Nginx Config') {
    steps {
        script {
            sshagent([SSH_CREDENTIALS_ID]) {
                sh '''
                    scp -o StrictHostKeyChecking=no ubuntu@${SERVER_IP}:/home/ubuntu/nginx.conf ./
                '''
            }
        }
    }
}

        // ë°°í¬ ë‹¨ê³„ (ë°±ì—”ë“œ ë° í”„ë¡ íŠ¸ì—”ë“œ ëª¨ë‘)
        stage('Deploy') {
            steps {
                sshagent([SSH_CREDENTIALS_ID]) {
                    sh """
                        ssh -o StrictHostKeyChecking=no ubuntu@${SERVER_IP} '
                            # ë°±ì—”ë“œ ë°°í¬
                            docker pull ${BACKEND_DOCKER_IMAGE}:${BACKEND_DOCKER_TAG}
                            docker stop backend || true
                            docker rm backend || true
                            docker run -d --name backend -p 8081:8080 ${BACKEND_DOCKER_IMAGE}:${BACKEND_DOCKER_TAG} # Change port to 8081
                            
                            # í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬
                            docker pull ${FRONTEND_DOCKER_IMAGE}:${FRONTEND_DOCKER_TAG}
                            docker stop frontend || true
                            docker rm frontend || true
                            docker run -d --name frontend -p 3000:3000 ${FRONTEND_DOCKER_IMAGE}:${FRONTEND_DOCKER_TAG}
                            
                            # Nginx ì„¤ì • ë° ì‹¤í–‰
                            docker stop nginx || true
                            docker rm nginx || true
                            # Ensure that nginx.conf is a regular file
                            docker run -d --name nginx -p 80:80 -v /home/ubuntu/nginx.conf:/etc/nginx/nginx.conf:ro nginx:alpine
                        '
                    """
                }
            }
        }
    }
}

```

### docker ì‹¤í–‰ ë°©ë²•
```jsx
docker run -d --name ${service} -p ${inPort}:${outPort}  ${DOCKERHUB_REPO}:: ${DOCKERHUB_TAG}:
```